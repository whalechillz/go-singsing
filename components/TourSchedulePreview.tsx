import React, { useState, useEffect } from 'react';
import { useSearchParams } from 'next/navigation';
import { supabase } from '@/lib/supabaseClient';
import { Download, Share2, Printer, Calendar, MapPin, Phone, Clock, Users, FileText, Eye, Home, Car, Flag, Building } from 'lucide-react';
import { BRAND_COLORS, DOCUMENT_COLOR_SCHEME } from '@/design-system/brand-colors';

interface TourSchedulePreviewProps {
  tourId: string;
}

// ÌÖçÏä§Ìä∏Î•º ÌååÏã±ÌïòÏó¨ "Ï†úÎ™©: ÎÇ¥Ïö©" ÌòïÏãùÏùÑ Î≥ºÎìú Ï≤òÎ¶¨ÌïòÎäî Ìï®Ïàò
const formatTextWithBold = (text: string): string => {
  if (!text) return '';
  return text.split('\n').map(line => {
    const colonIndex = line.indexOf(':');
    if (colonIndex > -1 && colonIndex < line.length - 1) {
      const title = line.substring(0, colonIndex).trim();
      const content = line.substring(colonIndex + 1).trim();
      return `<strong>${title}:</strong> ${content}`;
    }
    return line;
  }).join('<br>');
};

export default function TourSchedulePreview({ tourId }: TourSchedulePreviewProps) {
  const [tourData, setTourData] = useState<any>(null);
  const [productData, setProductData] = useState<any>(null);
  const [documentNotices, setDocumentNotices] = useState<any>({});
  const [documentFooters, setDocumentFooters] = useState<any>({});
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('customer_schedule');
  const [staffDocumentHTML, setStaffDocumentHTML] = useState<string>('');
  const [roomAssignmentHTML, setRoomAssignmentHTML] = useState<string>('');
  const [roomAssignmentStaffHTML, setRoomAssignmentStaffHTML] = useState<string>('');
  const [teeTimeHTML, setTeeTimeHTML] = useState<string>('');
  const [teeTimeStaffHTML, setTeeTimeStaffHTML] = useState<string>('');
  const [tourBoardingPlaces, setTourBoardingPlaces] = useState<any[]>([]);
  const [tourWaypoints, setTourWaypoints] = useState<any[]>([]);
  const searchParams = useSearchParams();

  // Î¨∏ÏÑú ÌÉÄÏûÖ Ï†ïÏùò
  const DOCUMENT_TYPES = [
    { id: 'customer_schedule', label: 'Í≥†Í∞ùÏö© ÏùºÏ†ïÌëú', icon: 'üìã' },
    { id: 'customer_boarding', label: 'Í≥†Í∞ùÏö© ÌÉëÏäπÏïàÎÇ¥ÏÑú', icon: 'üöå' },
    { id: 'staff_boarding', label: 'Ïä§ÌÉ≠Ïö© ÌÉëÏäπÏïàÎÇ¥ÏÑú', icon: 'üë•' },
    { id: 'room_assignment', label: 'Í∞ùÏã§ Î∞∞Ï†ïÌëú (Í≥†Í∞ùÏö©)', icon: 'üè®' },
    { id: 'room_assignment_staff', label: 'Í∞ùÏã§ Î∞∞Ï†ïÌëú (Ïä§ÌÉ≠Ïö©)', icon: 'üè®' },
    { id: 'timetable', label: 'Ìã∞ÌÉÄÏûÑÌëú (Í≥†Í∞ùÏö©)', icon: '‚õ≥' },
    { id: 'timetable-staff', label: 'Ìã∞ÌÉÄÏûÑÌëú (Ïä§ÌÉ≠Ïö©)', icon: '‚õ≥' },
    { id: 'simplified', label: 'Í∞ÑÌé∏ ÏùºÏ†ïÌëú', icon: 'üìÑ' }
  ];

  useEffect(() => {
    fetchTourData();
    fetchTourBoardingPlaces();
  }, [tourId]);

  // URL ÌååÎùºÎØ∏ÌÑ∞Î°ú Î∑∞ ÏûêÎèô ÏÑ†ÌÉù
  useEffect(() => {
    const view = searchParams.get('view');
    if (view && DOCUMENT_TYPES.some(doc => doc.id === view)) {
      setActiveTab(view);
    }
  }, [searchParams]);

  useEffect(() => {
    if (activeTab === 'staff_boarding' && tourData) {
      fetchParticipantsForStaff();
    } else if ((activeTab === 'room_assignment' || activeTab === 'room_assignment_staff') && tourData) {
      fetchRoomAssignments();
    } else if ((activeTab === 'timetable' || activeTab === 'timetable-staff') && tourData) {
      fetchTeeTimes();
    }
  }, [activeTab, tourData]);

  const fetchTourData = async () => {
    try {
      setLoading(true);
      
      // Ìà¨Ïñ¥ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
      const { data: tour, error: tourError } = await supabase
        .from('singsing_tours')
        .select(`
          *,
          singsing_tour_staff (*)
        `)
        .eq('id', tourId)
        .single();

      if (tourError) throw tourError;

      // ÏùºÏ†ï Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
      const { data: schedules, error: schedulesError } = await supabase
        .from('singsing_schedules')
        .select('*')
        .eq('tour_id', tourId)
        .order('date');

      if (schedulesError) throw schedulesError;
      
      console.log('Schedules data:', schedules);
      // ÏãùÏÇ¨ Ï†ïÎ≥¥ ÌôïÏù∏
      schedules?.forEach((schedule, idx) => {
        console.log(`Day ${idx + 1} ÏãùÏÇ¨ Ï†ïÎ≥¥:`, {
          meal_breakfast: schedule.meal_breakfast,
          menu_breakfast: schedule.menu_breakfast,
          meal_lunch: schedule.meal_lunch,
          menu_lunch: schedule.menu_lunch,
          meal_dinner: schedule.meal_dinner,
          menu_dinner: schedule.menu_dinner
        });
      });

      // Ïó¨ÌñâÏÉÅÌíà Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
      if (tour.tour_product_id) {
        const { data: product, error: productError } = await supabase
          .from('tour_products')
          .select('*')
          .eq('id', tour.tour_product_id)
          .single();

        if (!productError && product) {
          console.log('Product data:', product);
          setProductData(product);
        }
      }

      // Î¨∏ÏÑúÎ≥Ñ ÌïòÎã® ÎÇ¥Ïö© Í∞ÄÏ†∏Ïò§Í∏∞ - ÌÖåÏù¥Î∏îÏù¥ ÏóÜÏúºÎ©¥ Ïä§ÌÇµ
      try {
        const { data: footers, error: footersError } = await supabase
          .from('document_footers')
          .select('*')
          .eq('tour_id', tourId);

        if (!footersError && footers) {
          const footersByType = footers.reduce((acc, footer) => {
            if (!acc[footer.document_type]) {
              acc[footer.document_type] = {};
            }
            acc[footer.document_type][footer.section_title] = footer.content;
            return acc;
          }, {});
          setDocumentFooters(footersByType);
        }
      } catch (e) {
        console.log('document_footers ÌÖåÏù¥Î∏îÏù¥ ÏóÜÍ±∞ÎÇò Ï†ëÍ∑ºÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
        // Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©
        setDocumentFooters({});
      }

      // Îç∞Ïù¥ÌÑ∞ ÌÜµÌï©
      setTourData({
        ...tour,
        schedules: schedules,
        staff: tour.singsing_tour_staff || []
      });
    } catch (error) {
      console.error('Error fetching tour data:', error);
    } finally {
      setLoading(false);
    }
  };

  const fetchTourBoardingPlaces = async () => {
    try {
      // Ìà¨Ïñ¥ Ï†ÑÏ≤¥ Í∏∞Í∞Ñ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
      const { data: tourInfo } = await supabase
        .from('singsing_tours')
        .select('start_date, end_date')
        .eq('id', tourId)
        .single();

      if (!tourInfo) return;

      // Í∞ÄÎäî ÎÇ† ÌÉëÏäπÏßÄÎßå Í∞ÄÏ†∏Ïò§Í∏∞ (ÌÉëÏäπÏßÄÎäî Ï≤´ÎÇ†Îßå)
      const { data, error } = await supabase
        .from('singsing_tour_boarding_times')
        .select(`
          *,
          boarding_place:singsing_boarding_places (*)
        `)
        .eq('tour_id', tourId)
        .eq('is_waypoint', false)
        .eq('visit_date', tourInfo.start_date.split('T')[0])
        .order('order_no');

      if (error) {
        console.error('Error fetching tour boarding places:', error);
      } else {
        setTourBoardingPlaces(data || []);
      }

      // Ï†ÑÏ≤¥ Ìà¨Ïñ¥ Í∏∞Í∞ÑÏùò Î™®Îì† Í≤ΩÏú†ÏßÄ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
      const { data: waypoints } = await supabase
        .from('singsing_tour_boarding_times')
        .select('*')
        .eq('tour_id', tourId)
        .eq('is_waypoint', true)
        .order('visit_date')
        .order('order_no');

      if (waypoints) {
        // Í≤ΩÏú†ÏßÄ Ï§ë Í¥ÄÍ¥ëÏßÄÏôÄ Îß§Ïπ≠ÎêòÎäî Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        const enrichedWaypoints = await Promise.all(waypoints.map(async (waypoint) => {
          // waypoint_nameÏù¥ tourist_attractions ÌÖåÏù¥Î∏îÏóê ÏûàÎäîÏßÄ ÌôïÏù∏
          const { data: attractionData } = await supabase
            .from('tourist_attractions')
            .select('*')
            .ilike('name', `%${waypoint.waypoint_name}%`)
            .single();
          
          if (attractionData) {
            waypoint.attraction_data = attractionData;
          }
          return waypoint;
        }));
        
        console.log('Ï†ÑÏ≤¥ Í≤ΩÏú†ÏßÄ Ï†ïÎ≥¥:', enrichedWaypoints);
        setTourWaypoints(enrichedWaypoints);
      }
    } catch (error) {
      console.error('Error in fetchTourBoardingPlaces:', error);
      // ÌÖåÏù¥Î∏îÏù¥ ÏóÜÏùÑ Ïàò ÏûàÏúºÎØÄÎ°ú ÏòàÏô∏ Ï≤òÎ¶¨
      setTourBoardingPlaces([]);
    }
  };

  const fetchParticipantsForStaff = async () => {
    try {
      const { data: participants, error } = await supabase
        .from('singsing_participants')
        .select('*')
        .eq('tour_id', tourId)
        .eq('status', 'ÌôïÏ†ï')
        .order('pickup_location', { ascending: true })
        .order('team_name', { ascending: true })
        .order('name', { ascending: true });

      if (error) throw error;
      
      if (participants) {
        setStaffDocumentHTML(generateStaffHTML(participants));
      }
    } catch (error) {
      console.error('Error fetching participants:', error);
    }
  };

  const fetchRoomAssignments = async () => {
    try {
      // Ï∞∏Í∞ÄÏûê Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
      const { data: assignments, error } = await supabase
        .from('singsing_participants')
        .select('*')
        .eq('tour_id', tourId)
        .order('room_id');

      if (error) throw error;
      
      // Í∞ùÏã§ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
      const { data: rooms, error: roomsError } = await supabase
        .from('singsing_rooms')
        .select('*')
        .eq('tour_id', tourId)
        .order('room_number');
        
      if (roomsError) throw roomsError;
      
      // Ïä§ÌÉúÌîÑ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ (Í∏∞ÏÇ¨ Ï†ïÎ≥¥Î•º ÏúÑÌï¥)
      const { data: staffData } = await supabase
        .from('singsing_tour_staff')
        .select('*')
        .eq('tour_id', tourId)
        .eq('role', 'Í∏∞ÏÇ¨')
        .order('display_order')
        .limit(1);
      
      const tourStaff = staffData && staffData.length > 0 ? staffData[0] : null;
      console.log('Í∏∞ÏÇ¨ Ï†ïÎ≥¥:', tourStaff);
      
      if (assignments && rooms) {
        setRoomAssignmentHTML(generateRoomAssignmentHTML(assignments, rooms, tourStaff, false)); // Í≥†Í∞ùÏö©
        setRoomAssignmentStaffHTML(generateRoomAssignmentHTML(assignments, rooms, tourStaff, true)); // Ïä§ÌÉ≠Ïö©
      }
    } catch (error) {
      console.error('Error fetching room assignments:', error);
    }
  };

  const fetchTeeTimes = async () => {
    try {
      // Ìã∞ÌÉÄÏûÑ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
      const { data: teeTimes, error } = await supabase
        .from('singsing_tee_times')
        .select('*')
        .eq('tour_id', tourId)
        .order('play_date')
        .order('tee_time');

      if (error) {
        console.error('Ìã∞ÌÉÄÏûÑ Ï°∞Ìöå Ïò§Î•ò:', error);
        throw error;
      }
      
      console.log('Ìã∞ÌÉÄÏûÑ Îç∞Ïù¥ÌÑ∞:', teeTimes);
      
      if (teeTimes && teeTimes.length > 0) {
        // Í∞Å Ìã∞ÌÉÄÏûÑÎ≥ÑÎ°ú Î∞∞Ï†ïÎêú Ï∞∏Í∞ÄÏûê Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        const teeTimesWithPlayers = await Promise.all(teeTimes.map(async (teeTime) => {
          // singsing_participant_tee_times ÌÖåÏù¥Î∏îÏóêÏÑú Î∞∞Ï†ï Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
          const { data: assignments, error: assignError } = await supabase
            .from('singsing_participant_tee_times')
            .select(`
              participant_id,
              singsing_participants (
                id,
                name,
                phone,
                team_name,
                gender
              )
            `)
            .eq('tee_time_id', teeTime.id);
            
          if (assignError) {
            console.error('Î∞∞Ï†ï Ï†ïÎ≥¥ Ï°∞Ìöå Ïò§Î•ò:', assignError);
          }
          
          // Ìã∞ÌÉÄÏûÑ Îç∞Ïù¥ÌÑ∞Ïóê ÌîåÎ†àÏù¥Ïñ¥ Ï†ïÎ≥¥ Ï∂îÍ∞Ä
          return {
            ...teeTime,
            // ÌïÑÎìúÎ™Ö ÌÜµÏùº: play_date -> date, golf_course -> course
            date: teeTime.play_date || teeTime.date,
            course: teeTime.golf_course || teeTime.course,
            // Î∞∞Ï†ïÎêú Ï∞∏Í∞ÄÏûê Ï†ïÎ≥¥Î•º singsing_tee_time_players ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
            singsing_tee_time_players: assignments?.map((a, index) => ({
              participant_id: a.participant_id,
              order_no: index + 1,
              singsing_participants: a.singsing_participants
            })) || []
          };
        }));
        
        console.log('ÌîåÎ†àÏù¥Ïñ¥ Ï†ïÎ≥¥Í∞Ä Ìè¨Ìï®Îêú Ìã∞ÌÉÄÏûÑ Îç∞Ïù¥ÌÑ∞:', teeTimesWithPlayers);
        
        const customerHTML = generateTeeTimeHTML(teeTimesWithPlayers, false);
        const staffHTML = generateTeeTimeHTML(teeTimesWithPlayers, true);
        console.log('Í≥†Í∞ùÏö© HTML ÏÉùÏÑ±Îê®:', customerHTML.length);
        console.log('Ïä§ÌÉ≠Ïö© HTML ÏÉùÏÑ±Îê®:', staffHTML.length);
        setTeeTimeHTML(customerHTML); // Í≥†Í∞ùÏö©
        setTeeTimeStaffHTML(staffHTML); // Ïä§ÌÉ≠Ïö©
      } else {
        console.log('Ìã∞ÌÉÄÏûÑ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§');
        setTeeTimeHTML('<div class="no-data">Ìã∞ÌÉÄÏûÑ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</div>');
        setTeeTimeStaffHTML('<div class="no-data">Ìã∞ÌÉÄÏûÑ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</div>');
      }
    } catch (error) {
      console.error('Error fetching tee times:', error);
      setTeeTimeHTML('<div class="error">Ìã∞ÌÉÄÏûÑ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</div>');
      setTeeTimeStaffHTML('<div class="error">Ìã∞ÌÉÄÏûÑ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</div>');
    }
  };

  const handlePrint = () => {
    window.print();
  };

  const handleDownload = () => {
    const content = getDocumentHTML();
    const blob = new Blob([content], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${tourData.title}_${activeTab}_${new Date().toISOString().split('T')[0]}.html`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const handleShare = () => {
    if (navigator.share) {
      navigator.share({
        title: tourData?.title,
        text: `${tourData?.title} Î¨∏ÏÑú`,
        url: window.location.href,
      });
    }
  };

  // Î¨∏ÏÑúÎ≥Ñ HTML ÏÉùÏÑ±
  const getDocumentHTML = () => {
    switch (activeTab) {
      case 'customer_schedule':
        return getCustomerScheduleHTML();
      case 'customer_boarding':
        return getCustomerBoardingHTML();
      case 'staff_boarding':
        return staffDocumentHTML || '<div>Ïä§ÌÉ≠Ïö© Î¨∏ÏÑúÎ•º ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§...</div>';
      case 'room_assignment':
        return roomAssignmentHTML || '<div>Í∞ùÏã§ Î∞∞Ï†ïÌëúÎ•º ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§...</div>';
      case 'room_assignment_staff':
        return roomAssignmentStaffHTML || '<div>Í∞ùÏã§ Î∞∞Ï†ïÌëúÎ•º ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§...</div>';
      case 'timetable':
        return teeTimeHTML || '<div>Ìã∞ÌÉÄÏûÑÌëúÎ•º ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§...</div>';
      case 'timetable-staff':
        return teeTimeStaffHTML || '<div>Ìã∞ÌÉÄÏûÑÌëúÎ•º ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§...</div>';
      case 'simplified':
        return getSimplifiedScheduleHTML();
      default:
        return getCustomerScheduleHTML();
    }
  };

  // Í≥†Í∞ùÏö© ÏùºÏ†ïÌëú HTML
  const getCustomerScheduleHTML = () => {
    const notices = documentNotices.customer_schedule || [];
    
    return `<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${tourData.title} - Í≥†Í∞ùÏö© ÏùºÏ†ïÌëú</title>
  <style>
    ${getCustomerScheduleStyles()}
  </style>
</head>
<body>
  <div class="container">
    <!-- Ìó§Îçî -->
    <div class="header">
      <div class="logo">Ïã±Ïã±Í≥®ÌîÑÌà¨Ïñ¥</div>
      <div class="company-info">
        ÏàòÏõêÏãú ÏòÅÌÜµÍµ¨ Î≤ïÏ°∞Î°ú149Î≤àÍ∏∏ 200<br>
        Í≥†Í∞ùÏÑºÌÑ∞ TEL 031-215-3990
      </div>
    </div>
    
    <!-- ÏÉÅÌíà Ï†ïÎ≥¥ -->
    <div class="section">
      <div class="section-title">ÏÉÅÌíà Ï†ïÎ≥¥</div>
      <div class="product-info-box">
        <div class="info-row">
          <div class="info-label">ÏÉÅÌíàÎ™Ö</div>
          <div class="info-value important">${tourData.title}</div>
        </div>
        <div class="info-row">
          <div class="info-label">ÏùºÏ†ï</div>
          <div class="info-value important">
            ${new Date(tourData.start_date).toLocaleDateString('ko-KR')} ~ 
            ${new Date(tourData.end_date).toLocaleDateString('ko-KR')}
          </div>
        </div>
        <div class="info-row">
          <div class="info-label">Í≥®ÌîÑÏû•</div>
          <div class="info-value">
            ${productData?.golf_course || ''}
          </div>
        </div>
        ${productData?.courses?.length > 0 ? `
        <div class="info-row">
          <div class="info-label">ÏΩîÏä§</div>
          <div class="info-value">${productData.courses.join(', ')}</div>
        </div>
        ` : ''}
        <div class="info-row">
          <div class="info-label">ÏàôÏÜå</div>
          <div class="info-value">${productData?.hotel || ''}</div>
        </div>
        <div class="info-row">
          <div class="info-label">Ìè¨Ìï®ÏÇ¨Ìï≠</div>
          <div class="info-value">${productData?.included_items || ''}</div>
        </div>
        <div class="info-row">
          <div class="info-label">Î∂àÌè¨Ìï®ÏÇ¨Ìï≠</div>
          <div class="info-value">${productData?.excluded_items || ''}</div>
        </div>
      </div>
    </div>

    <!-- ÌäπÎ≥Ñ Í≥µÏßÄÏÇ¨Ìï≠ (Ìà¨Ïñ¥) -->
    ${tourData.special_notices && tourData.special_notices.length > 0 ? `
      <div class="section">
        <div class="section-title">ÌäπÎ≥Ñ Í≥µÏßÄÏÇ¨Ìï≠</div>
        <div class="notice-box">
          <ul class="notice-list">
            ${tourData.special_notices.map((notice: any) => 
              `<li>${notice.content || notice}</li>`
            ).join('') || ''}
          </ul>
        </div>
      </div>
    ` : ''}

    <!-- ÏùºÎ∞ò Í≥µÏßÄÏÇ¨Ìï≠ (Ïó¨ÌñâÏÉÅÌíà) -->
    ${productData?.general_notices && productData.general_notices.length > 0 ? `
      <div class="section">
        <div class="section-title">ÏòàÏïΩ ÏïàÎÇ¥ ÏÇ¨Ìï≠</div>
        <div class="notice-box">
          <ul class="notice-list">
            ${productData.general_notices.map((notice: any) => `
              <li>${notice.content || notice}</li>
            `).join('')}
          </ul>
        </div>
      </div>
    ` : productData?.usage_round || productData?.usage_hotel || productData?.usage_meal || productData?.usage_bus || productData?.usage_tour || productData?.usage_locker ? `
      <div class="section">
        <div class="section-title">ÏòàÏïΩ ÏïàÎÇ¥ ÏÇ¨Ìï≠</div>
        <div class="notice-box">
          <ul class="notice-list">
            ${productData.usage_round ? `<li>ÎùºÏö¥Îî© Í∑úÏ†ï: ${productData.usage_round}</li>` : ''}
            ${productData.usage_hotel ? `<li>ÏàôÏÜå Ïù¥Ïö©: ${productData.usage_hotel}</li>` : ''}
            ${productData.usage_meal ? `<li>ÏãùÏÇ¨ ÏïàÎÇ¥: ${productData.usage_meal}</li>` : ''}
            ${productData.usage_locker ? `<li>ÎùΩÏπ¥ Ïù¥Ïö©: ${productData.usage_locker}</li>` : ''}
            ${productData.usage_bus ? `<li>Î≤ÑÏä§ Ïù¥Ïö©: ${productData.usage_bus}</li>` : ''}
            ${productData.usage_tour ? `<li>Í¥ÄÍ¥ëÏßÄ Ìà¨Ïñ¥: ${productData.usage_tour}</li>` : ''}
          </ul>
        </div>
      </div>
    ` : ''}

    <!-- ÏòàÏïΩ ÏïàÎÇ¥ÏÇ¨Ìï≠ (Ìà¨Ïñ¥) -->
    ${tourData.reservation_notices?.length > 0 ? `
      <div class="section">
        <div class="section-title">ÏòàÏïΩ ÏïàÎÇ¥ÏÇ¨Ìï≠</div>
        <div class="reservation-box">
          <ul class="reservation-list">
            ${tourData.reservation_notices.map((notice: any) => `
              <li>${notice.title}: ${notice.content}</li>
            `).join('')}
          </ul>
        </div>
      </div>
    ` : ''}
    
    <!-- ÏùºÏ†ï ÏïàÎÇ¥ -->
    <div class="section">
      <div class="section-title">ÏùºÏ†ï ÏïàÎÇ¥</div>
      <div class="schedule-section" style="padding-top: 5px;">
        ${tourData.schedules?.map((schedule: any, idx: number) => `
          <div class="day-schedule">
            <div class="day-title">
              <div>Day ${idx + 1} - ${new Date(schedule.date || schedule.schedule_date).toLocaleDateString('ko-KR')}</div>
              <div class="day-round">${schedule.title || ''}</div>
            </div>
            <div class="day-content">
              <div class="schedule-content">
                ${schedule.schedule_items?.length > 0 ? `
                  <div class="schedule-timeline">
                    ${schedule.schedule_items.map((item: any) => {
                      // ÏïÑÏù¥ÏΩò Í≤∞Ï†ï
                      let icon = '';
                      let iconClass = '';
                      const content = item.content.toLowerCase();
                      
                      if (content.includes('ÌÉëÏäπ') || content.includes('Ï∂úÎ∞ú')) {
                        icon = 'üöå';
                        iconClass = 'departure';
                      } else if (content.includes('Ïù¥Îèô') || content.includes('Í≤ΩÏú†')) {
                        icon = 'üöó';
                        iconClass = 'transit';
                      } else if (content.includes('ÎùºÏö¥Îìú') || content.includes('Í≥®ÌîÑ')) {
                        icon = '‚õ≥';
                        iconClass = 'golf';
                      } else if (content.includes('Ï°∞Ïãù') || content.includes('ÏïÑÏπ®')) {
                        icon = 'üåÖ';
                        iconClass = 'meal';
                      } else if (content.includes('Ï§ëÏãù') || content.includes('Ï†êÏã¨')) {
                        icon = 'üç¥';
                        iconClass = 'meal';
                      } else if (content.includes('ÏÑùÏãù') || content.includes('Ï†ÄÎÖÅ')) {
                        icon = 'üåô';
                        iconClass = 'meal';
                      } else if (content.includes('Ìú¥Ïãù') || content.includes('ÏûêÏú†')) {
                        icon = 'üè®';
                        iconClass = 'rest';
                      } else if (content.includes('ÎèÑÏ∞©')) {
                        icon = 'üìç';
                        iconClass = 'arrival';
                      } else if (content.includes('ÎßàÌä∏') || content.includes('ÏáºÌïë')) {
                        icon = 'üõí';
                        iconClass = 'shopping';
                      } else if (content.includes('Í¥ÄÍ¥ë') || content.includes('Ìà¨Ïñ¥')) {
                        icon = 'üèõÔ∏è';
                        iconClass = 'tour';
                      } else {
                        icon = '‚Ä¢';
                        iconClass = 'default';
                      }
                      
                      return `
                        <div class="timeline-item ${iconClass}">
                          <div class="timeline-icon">${icon}</div>
                          <div class="timeline-content">
                            ${item.time ? `<span class="timeline-time">${item.time}</span>` : ''}
                            <span class="timeline-text">${item.content}</span>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                ` : schedule.description ? `<p class="schedule-description">${schedule.description}</p>` : ''}
              </div>
              
              <div class="meal-info">
                <div class="meal">
                  <div>Ï°∞Ïãù</div>
                  <div class="meal-status ${schedule.meal_breakfast ? 'included' : 'not-included'}">
                    ${schedule.meal_breakfast ? 'O' : 'X'}
                  </div>
                </div>
                <div class="meal">
                  <div>Ï§ëÏãù</div>
                  <div class="meal-status ${schedule.meal_lunch ? 'included' : 'not-included'}">
                    ${schedule.meal_lunch ? 'O' : 'X'}
                  </div>
                </div>
                <div class="meal">
                  <div>ÏÑùÏãù</div>
                  <div class="meal-status ${schedule.meal_dinner ? 'included' : 'not-included'}">
                    ${schedule.meal_dinner ? 'O' : 'X'}
                  </div>
                </div>
              </div>
              ${(schedule.meal_breakfast && schedule.menu_breakfast) || 
                (schedule.meal_lunch && schedule.menu_lunch) || 
                (schedule.meal_dinner && schedule.menu_dinner) ? `
              <div class="meal-menu-section">
                <div class="meal-menu-title">ÏãùÏÇ¨ Î©îÎâ¥</div>
                ${schedule.meal_breakfast && schedule.menu_breakfast ? `<div class="meal-menu-item">Ï°∞Ïãù: ${schedule.menu_breakfast}</div>` : ''}
                ${schedule.meal_lunch && schedule.menu_lunch ? `<div class="meal-menu-item">Ï§ëÏãù: ${schedule.menu_lunch}</div>` : ''}
                ${schedule.meal_dinner && schedule.menu_dinner ? `<div class="meal-menu-item">ÏÑùÏãù: ${schedule.menu_dinner}</div>` : ''}
              </div>
              ` : ''}
            </div>
          </div>
        `).join('') || ''}
      </div>
    </div>

    <!-- Ïù¥Ïö© ÏïàÎÇ¥ (Ïó¨ÌñâÏÉÅÌíà) -->
    ${productData?.usage_round || productData?.usage_hotel || productData?.usage_meal || productData?.usage_bus || productData?.usage_tour || productData?.usage_locker ? `
      <div class="section">
        <div class="section-title">Ïù¥Ïö© ÏïàÎÇ¥</div>
        <div class="usage-section">
          ${productData.usage_round ? `
            <div class="usage-item">
              <div class="usage-header">ÎùºÏö¥Îî© Í∑úÏ†ï</div>
              <div class="usage-content">${formatTextWithBold(productData.usage_round)}</div>
            </div>
          ` : ''}
          ${productData.usage_hotel ? `
            <div class="usage-item">
              <div class="usage-header">ÏàôÏÜå Ïù¥Ïö©</div>
              <div class="usage-content">${formatTextWithBold(productData.usage_hotel)}</div>
            </div>
          ` : ''}
          ${productData.usage_meal ? `
            <div class="usage-item">
              <div class="usage-header">ÏãùÏÇ¨ ÏïàÎÇ¥</div>
              <div class="usage-content">${formatTextWithBold(productData.usage_meal)}</div>
            </div>
          ` : ''}
          ${productData.usage_locker ? `
            <div class="usage-item">
              <div class="usage-header">ÎùΩÏπ¥ Ïù¥Ïö©</div>
              <div class="usage-content">${formatTextWithBold(productData.usage_locker)}</div>
            </div>
          ` : ''}
          ${productData.usage_bus ? `
            <div class="usage-item">
              <div class="usage-header">Î≤ÑÏä§ Ïù¥Ïö©</div>
              <div class="usage-content">${formatTextWithBold(productData.usage_bus)}</div>
            </div>
          ` : ''}
          ${productData.usage_tour ? `
            <div class="usage-item">
              <div class="usage-header">Í¥ÄÍ¥ëÏßÄ Ìà¨Ïñ¥</div>
              <div class="usage-content">${formatTextWithBold(productData.usage_tour)}</div>
            </div>
          ` : ''}
        </div>
      </div>
    ` : ''}

    <!-- Í∏∞ÌÉÄ ÏïàÎÇ¥Î¨∏Íµ¨ -->
    ${tourData.other_notices ? `
      <div class="other-notice">
        ${tourData.other_notices}
      </div>
    ` : ''}
    
    <div class="footer">
      <p>‚ô° Ï¶êÍ±∞Ïö¥ ÌïòÎ£® ÎêòÏãúÍ∏∏ Î∞îÎûçÎãàÎã§. ‚ô°</p>
      <p>Ïã±Ïã±Í≥®ÌîÑÌà¨Ïñ¥ ‚òé 031-215-3990</p>
    </div>
  </div>
</body>
</html>`;
  };

  // Í≥†Í∞ùÏö© ÌÉëÏäπÏïàÎÇ¥ÏÑú HTML
  const getCustomerBoardingHTML = () => {
    const notices = documentNotices.customer_boarding || [];
    
    return `<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${tourData.title} - ÌÉëÏäπ ÏïàÎÇ¥</title>
  <style>
    ${getBoardingGuideStyles()}
  </style>
</head>
<body>
  <div class="container">
    ${/* Ìó§Îçî ÌïòÎÇòÎ°ú ÌÜµÌï© */''}
    <div class="route-section">
      <div class="route-header-box">
        <div class="route-header-title">Ïã±Ïã±Í≥®ÌîÑÌà¨Ïñ¥</div>
        <div class="route-header-subtitle">${tourData.title}</div>
        <div class="route-header-date">${tourData.start_date && tourData.end_date ? `${new Date(tourData.start_date).toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric' }).replace('. ', '/').replace('.', '')}(${['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'][new Date(tourData.start_date).getDay()]})~${new Date(tourData.end_date).toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric' }).replace('. ', '/').replace('.', '')}(${['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'][new Date(tourData.end_date).getDay()]})` : ''}</div>
      </div>
      <div class="boarding-cards">
        ${tourBoardingPlaces.map((place: any, index: number) => {
          const boardingPlace = place.boarding_place;
          if (!boardingPlace) return '';
          const departureTime = place.departure_time ? place.departure_time.slice(0, 5) : 'ÎØ∏Ï†ï';
          const hour = departureTime !== 'ÎØ∏Ï†ï' ? parseInt(departureTime.split(':')[0]) : 0;
          const timePrefix = hour < 12 ? 'Ïò§Ï†Ñ' : 'Ïò§ÌõÑ';
          const displayHour = hour > 12 ? hour - 12 : hour;
          const displayTime = departureTime !== 'ÎØ∏Ï†ï' ? `${displayHour}:${departureTime.split(':')[1]}` : 'ÎØ∏Ï†ï';
          
          // Í¥ÄÍ¥ëÏßÄ Ïù¥ÎØ∏ÏßÄ ÌëúÏãú (Ï†úÍ±∞)
          
          return `
          <div class="boarding-card route-stop">
            <div class="card-border"></div>
            <div class="card-content">
              <div class="route-header">
                <div class="route-number">${index + 1}</div>
                <div class="route-info-main">
                  <div class="card-title">
                    <span class="location-name">${boardingPlace.name}</span>
                    <span class="location-type">(${boardingPlace.district || 'ÌÉëÏäπÏßÄ'})</span>
                  </div>
                  <div class="time-wrapper">
                    <span class="time-prefix" style="font-size: inherit;">${timePrefix}</span>
                    <span class="card-time">${displayTime}</span>
                  </div>
                  <div class="card-date">${new Date(tourData.start_date).toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric' }).replace('. ', 'Ïõî ').replace('.', 'Ïùº')} (${['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'][new Date(tourData.start_date).getDay()]})</div>
                </div>
              </div>
              
              <div class="card-info">
                <div class="info-parking">Ï£ºÏ∞®: ${boardingPlace.parking_info || 'Î¨¥Î£å'}</div>
                <div class="info-arrival">${place.arrival_time ? place.arrival_time.slice(0, 5) : getArrivalTime(place.departure_time)} ÎèÑÏ∞©</div>
              </div>
              
              ${boardingPlace.boarding_main || boardingPlace.boarding_sub || boardingPlace.parking_main ? `
                <div class="location-info">
                  ${boardingPlace.boarding_main ? `
                    <div class="location-section">
                      <p class="location-title">üìç Î≤ÑÏä§ÌÉëÏäπÏßÄ</p>
                      <p class="location-main">${boardingPlace.boarding_main}</p>
                      ${boardingPlace.boarding_sub ? `<p class="location-sub">${boardingPlace.boarding_sub}</p>` : ''}
                    </div>
                  ` : ''}
                  
                  ${boardingPlace.parking_main ? `
                    <div class="location-section">
                      <p class="location-title">üìç Ï£ºÏ∞®Ïû• Ïò§ÎäîÍ∏∏</p>
                      <p class="location-main">${boardingPlace.parking_main}</p>
                      ${boardingPlace.parking_map_url ? `
                        <a href="${boardingPlace.parking_map_url}" class="map-link" target="_blank">ÎÑ§Ïù¥Î≤Ñ ÏßÄÎèÑÏóêÏÑú Î≥¥Í∏∞</a>
                      ` : ''}
                    </div>
                  ` : ''}
                </div>
              ` : ''}
            </div>
          </div>
          `;
        }).join('')}
        
        ${tourWaypoints.map((waypoint: any, waypointIndex: number) => {
          const orderNumber = tourBoardingPlaces.length + waypointIndex + 1;
          const isRestStop = waypoint.waypoint_name?.includes('Ìú¥Í≤åÏÜå');
          const isTourist = waypoint.waypoint_name?.includes('ÏÜ°Í¥ëÏÇ¨') || waypoint.waypoint_name?.includes('Í¥ÄÍ¥ë') || waypoint.waypoint_name?.includes('ÏÇ¨Ï∞∞');
          
          // ÎÇ†Ïßú ÌëúÏãú
          const waypointDate = waypoint.visit_date ? new Date(waypoint.visit_date) : null;
          const startDate = new Date(tourData.start_date);
          const dayNumber = waypointDate ? Math.floor((waypointDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24)) + 1 : 0;
          
          const waypointTime = waypoint.waypoint_time ? waypoint.waypoint_time.slice(0, 5) : 'ÎØ∏Ï†ï';
          const hour = waypointTime !== 'ÎØ∏Ï†ï' ? parseInt(waypointTime.split(':')[0]) : 0;
          const timePrefix = hour < 12 ? 'Ïò§Ï†Ñ' : 'Ïò§ÌõÑ';
          const displayHour = hour > 12 ? hour - 12 : hour;
          const displayTime = waypointTime !== 'ÎØ∏Ï†ï' ? `${displayHour}:${waypointTime.split(':')[1]}` : 'ÎØ∏Ï†ï';
          
          // ÏïÑÏù¥ÏΩò ÏÑ§Ï†ï
          const icon = isRestStop ? '‚òï' : isTourist ? 'üèõÔ∏è' : 'üìç';
          
          return `
          <div class="boarding-card waypoint-stop">
            <div class="card-border ${isRestStop ? 'rest-stop' : isTourist ? 'tourist-stop' : ''}"></div>
            <div class="card-content">
              ${waypoint.attraction_data?.main_image_url || waypoint.attraction_data?.image_urls?.[0] ? `
                <div class="attraction-image-container">
                  <img src="${waypoint.attraction_data.main_image_url || waypoint.attraction_data.image_urls[0]}" alt="${waypoint.waypoint_name}" class="attraction-image" />
                </div>
              ` : ''}
              <div class="route-header">
                <div class="route-number ${isRestStop ? 'rest' : isTourist ? 'tourist' : ''}">${orderNumber}</div>
                <div class="route-info-main">
                  <div class="card-title">
                    <span class="waypoint-icon">${icon}</span>
                    <span class="location-name">${waypoint.waypoint_name}</span>
                  </div>
                  <div class="time-wrapper">
                    <span class="time-prefix" style="font-size: inherit;">${timePrefix}</span>
                    <span class="card-time waypoint-time">${displayTime}</span>
                  </div>
                  ${waypointDate ? `<div class="card-date">${waypointDate.toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric' }).replace('. ', 'Ïõî ').replace('.', 'Ïùº')} (${['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'][waypointDate.getDay()]})</div>` : ''}
                </div>
              </div>
              
              <div class="waypoint-info">
                <div class="waypoint-duration">Ï†ïÏ∞®ÏãúÍ∞Ñ: ÏïΩ ${waypoint.waypoint_duration || waypoint.attraction_data?.recommended_duration || 30}Î∂Ñ</div>
                ${waypoint.waypoint_description ? `<div class="waypoint-desc">${waypoint.waypoint_description}</div>` : ''}
                ${waypoint.attraction_data ? `
                  <div class="attraction-info">
                    ${waypoint.attraction_data.description ? `<div class="attraction-desc">${waypoint.attraction_data.description}</div>` : ''}
                    ${waypoint.attraction_data.features?.length > 0 ? `
                      <div class="attraction-features">
                        ${waypoint.attraction_data.features.map((feature: string) => `<span class="feature-tag">${feature}</span>`).join('')}
                      </div>
                    ` : ''}
                    ${waypoint.attraction_data.address ? `<div class="attraction-address">üìç ${waypoint.attraction_data.address}</div>` : ''}
                  </div>
                ` : ''}
              </div>
            </div>
          </div>
          `;
        }).join('')}
      </div>
    </div>
    
    <div class="common-info">
      ${documentFooters.boarding_guide?.['ÌÉëÏäπ Ï£ºÏùòÏÇ¨Ìï≠'] ? `
        <h3 class="section-title">ÌÉëÏäπ Ï£ºÏùòÏÇ¨Ìï≠</h3>
        <ul class="notice-list">
          ${documentFooters.boarding_guide['ÌÉëÏäπ Ï£ºÏùòÏÇ¨Ìï≠'].split('\n').map((line: string) => `
            <li class="notice-item">${line.replace('‚Ä¢', '').trim()}</li>
          `).join('')}
        </ul>
      ` : ''}
      
      ${tourData.staff?.length > 0 ? `
        <div class="contact-box">
          <div class="contact-title">ÎπÑÏÉÅ Ïó∞ÎùΩÏ≤ò</div>
          ${tourData.staff.map((staff: any) => `
            <div class="contact-phone">${staff.name} ${staff.role} - ${staff.phone}</div>
          `).join('')}
        </div>
      ` : ''}
    </div>
    
    <div class="footer">
      <p>Ï¶êÍ±∞Ïö¥ Í≥®ÌîÑ Ïó¨Ìñâ ÎêòÏãúÍ∏∏ Î∞îÎûçÎãàÎã§</p>
      <p>Ïã±Ïã±Í≥®ÌîÑÌà¨Ïñ¥ | 031-215-3990</p>
    </div>
  </div>
</body>
</html>`;
  };

  // Í∞ÑÌé∏ ÏùºÏ†ïÌëú HTML
  const getSimplifiedScheduleHTML = () => {
    const notices = documentNotices.simplified || [];
    
    return `<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${tourData.title} - Í∞ÑÌé∏ ÏùºÏ†ïÌëú</title>
  <style>
    ${getSimplifiedStyles()}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>${tourData.title}</h1>
      <p>${new Date(tourData.start_date).toLocaleDateString('ko-KR')} ~ ${new Date(tourData.end_date).toLocaleDateString('ko-KR')}</p>
    </div>
    
    <div class="quick-info">
      <div class="info-item">
        <Flag className="icon" />
        <div>
          <strong>Í≥®ÌîÑÏû•</strong>
          <p>${productData?.golf_course || ''}</p>
        </div>
      </div>
      <div class="info-item">
        <Building className="icon" />
        <div>
          <strong>ÏàôÏÜå</strong>
          <p>${productData?.hotel || ''}</p>
        </div>
      </div>
    </div>
    
    <div class="schedule-summary">
      ${tourData.schedules?.map((schedule: any) => `
        <div class="day-summary">
          <div class="day-header">Day ${schedule.day_number}</div>
          <div class="day-date">${new Date(schedule.date).toLocaleDateString('ko-KR')}</div>
          <div class="main-events">
            ${schedule.tour_schedule_items?.filter((item: any) =>
              item.content.includes('Í≥®ÌîÑ') || item.content.includes('Ï∂úÎ∞ú') || item.content.includes('ÎèÑÏ∞©')
            ).map((item: any) => `
              <div class="event">${item.time || ''} ${item.content}</div>
            `).join('') || ''}
          </div>
        </div>
      `).join('') || ''}
    </div>
    
    ${notices.length > 0 ? `
      <div class="notices">
        ${notices.map((notice: any) => `
          <p>${notice.content}</p>
        `).join('')}
      </div>
    ` : ''}
    
    <div class="footer">
      <p>Ïã±Ïã±Í≥®ÌîÑÌà¨Ïñ¥ ‚òé 031-215-3990</p>
    </div>
  </div>
</body>
</html>`;
  };

  // Í∞ùÏã§ Î∞∞Ï†ïÌëú HTML ÏÉùÏÑ±
  const generateRoomAssignmentHTML = (assignments: any[], rooms: any[], tourStaff: any, isStaff: boolean = false) => {
    // Ï∞∏Í∞ÄÏûêÎ•º room_idÎ°ú Í∑∏Î£πÌôî
    const participantsByRoom = assignments.reduce((acc, participant) => {
      const roomId = participant.room_id;
      if (!roomId) return acc;
      if (!acc[roomId]) acc[roomId] = [];
      acc[roomId].push(participant);
      return acc;
    }, {} as Record<string, any[]>);

    // Í∞ùÏã§ Ï†ïÎ≥¥Î•º IDÎ°ú Îß§Ìïë
    const roomsMap = rooms.reduce((acc, room) => {
      acc[room.id] = room;
      return acc;
    }, {} as Record<string, any>);

    const notices = documentNotices.room_assignment || [];

    return `<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${tourData.title} - Í∞ùÏã§ Î∞∞Ï†ïÌëú${isStaff ? ' (Ïä§ÌÉ≠Ïö©)' : ''}</title>
  <style>
    ${getRoomAssignmentStyles()}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Í∞ùÏã§ Î∞∞Ï†ïÌëú${isStaff ? ' (Ïä§ÌÉ≠Ïö©)' : ''}</h1>
      <p style="font-size: 20px; font-weight: bold; margin: 10px 0;">${tourData.title}</p>
    </div>
    
    <div class="content">
      ${rooms.sort((a, b) => {
        // room_numberÍ∞Ä ÏûàÏúºÎ©¥ Í∑∏Í±∏Î°ú Ï†ïÎ†¨, ÏóÜÏúºÎ©¥ room_seqÎ°ú Ï†ïÎ†¨
        if (a.room_number && b.room_number) {
          return a.room_number.localeCompare(b.room_number, 'ko', { numeric: true });
        }
        return (a.room_seq || 0) - (b.room_seq || 0);
      }).map(room => {
        const roomParticipants = participantsByRoom[room.id] || [];
        const isEmpty = roomParticipants.length === 0;
        
        return `
        <div class="room-card">
          <div class="room-header">
            <span class="room-number">${room.room_number || `Í∞ùÏã§ ${room.room_seq || ''}`}</span>
            <span class="room-type">${room.room_type}</span>
            <span class="room-capacity">${roomParticipants.length}/${room.capacity}Î™Ö</span>
          </div>
          <div class="room-body">
            ${isEmpty ? `
              <div class="empty-room">Îπà Í∞ùÏã§</div>
            ` : `
              <table class="participant-table">
                <thead>
                  <tr>
                    <th style="width: 40px;">No</th>
                    <th>ÏÑ±Î™Ö</th>
                    ${isStaff ? '<th style="width: 120px;">Ïó∞ÎùΩÏ≤ò</th>' : ''}
                    <th style="width: 100px;">ÌåÄ</th>
                    ${isStaff ? '<th>ÎπÑÍ≥†</th>' : ''}
                  </tr>
                </thead>
                <tbody>
                  ${roomParticipants.map((participant: any, index: number) => `
                    <tr>
                      <td class="text-center">${index + 1}</td>
                      <td class="text-center">${participant.name}</td>
                      ${isStaff ? `<td class="text-center">${participant.phone || '-'}</td>` : ''}
                      <td class="text-center">${participant.team_name || '-'}</td>
                      ${isStaff ? `<td>${participant.note || '-'}</td>` : ''}
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `}
          </div>
        </div>
        `;
      }).join('')}
      

    </div>
    

    

  </div>
</body>
</html>`;
  };

  // Ìã∞ÌÉÄÏûÑÌëú HTML ÏÉùÏÑ±
  const generateTeeTimeHTML = (teeTimes: any[], isStaff: boolean = false) => {
    const teeTimesByDate = teeTimes.reduce((acc, teeTime) => {
      const date = teeTime.date || teeTime.play_date;
      if (!acc[date]) acc[date] = [];
      acc[date].push(teeTime);
      return acc;
    }, {});

    const notices = documentNotices.tee_time || [];

    return `<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${tourData.title} - Ìã∞ÌÉÄÏûÑÌëú${isStaff ? ' (Ïä§ÌÉ≠Ïö©)' : ''}</title>
  <style>
    ${getTeeTimeStyles()}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Ìã∞ÌÉÄÏûÑÌëú${isStaff ? ' (Ïä§ÌÉ≠Ïö©)' : ''}</h1>
      <p>${tourData.title}</p>
      <p>${productData?.golf_course || ''}</p>
    </div>
    
    ${Object.entries(teeTimesByDate).map(([date, times]: [string, any]) => `
      <div class="tee-time-section">
        <h2>${new Date(date).toLocaleDateString('ko-KR')}</h2>
        <table>
          <thead>
            <tr>
              <th width="80">ÏãúÍ∞Ñ</th>
              <th width="100">ÏΩîÏä§</th>
              <th width="60">ÌåÄ</th>
              <th>ÌîåÎ†àÏù¥Ïñ¥</th>
                ${isStaff ? '<th>Ïó∞ÎùΩÏ≤ò</th>' : ''}
            </tr>
          </thead>
          <tbody>
            ${times.map((teeTime: any) => {
              // Ìã∞ÌÉÄÏûÑÏóê Î∞∞Ï†ïÎêú Ï∞∏Í∞ÄÏûê Ï†ïÎ≥¥
              const players = teeTime.singsing_tee_time_players || [];
              const sortedPlayers = players.sort((a: any, b: any) => (a.order_no || 0) - (b.order_no || 0));
              
              // ÌåÄ ÏÑ±Î≥Ñ Î∂ÑÏÑù
              const teamGenderAnalysis = () => {
                const maleCount = sortedPlayers.filter((p: any) => 
                  p.singsing_participants?.gender === 'M' || p.singsing_participants?.gender === 'ÎÇ®'
                ).length;
                const femaleCount = sortedPlayers.filter((p: any) => 
                  p.singsing_participants?.gender === 'F' || p.singsing_participants?.gender === 'Ïó¨'
                ).length;
                
                if (maleCount > 0 && femaleCount > 0) return '(ÌòºÏÑ±ÌåÄ)';
                if (maleCount > 0) return '(ÎÇ®ÏÑ±ÌåÄ)';
                if (femaleCount > 0) return '(Ïó¨ÏÑ±ÌåÄ)';
                return '';
              };
              
              const teamGenderType = teamGenderAnalysis();
              
              // Ìã∞ÌÉÄÏûÑÏóê ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÏûàÎäî Í≤ΩÏö∞
              if (sortedPlayers.length > 0) {
                return sortedPlayers.map((player: any, index: number) => {
                  const participant = player.singsing_participants;
                  if (!participant) return '';
                  
                  // Í∞úÎ≥Ñ ÏÑ±Î≥Ñ ÌëúÏãú (ÌòºÏÑ±ÌåÄÏóêÏÑú ÏÜåÏàò ÏÑ±Î≥ÑÎßå)
                  const getGenderMark = () => {
                  if (!participant.gender) return '';
                  
                  const maleCount = sortedPlayers.filter((p: any) => 
                  p.singsing_participants?.gender === 'M' || p.singsing_participants?.gender === 'ÎÇ®'
                  ).length;
                  const femaleCount = sortedPlayers.filter((p: any) => 
                  p.singsing_participants?.gender === 'F' || p.singsing_participants?.gender === 'Ïó¨'
                  ).length;
                  
                  if (maleCount > 0 && femaleCount > 0) {
                  if (maleCount < femaleCount && (participant.gender === 'M' || participant.gender === 'ÎÇ®')) {
                  return '(ÎÇ®)';
                  } else if (femaleCount < maleCount && (participant.gender === 'F' || participant.gender === 'Ïó¨')) {
                  return '(Ïó¨)';
                  }
                  }
                  return '';
                  };
                  
                  const genderMark = getGenderMark();
                  const genderColor = (participant.gender === 'M' || participant.gender === 'ÎÇ®') ? '#3b82f6' : 
                  (participant.gender === 'F' || participant.gender === 'Ïó¨') ? '#ec4899' : 
                  '#6b7280';
              
              const courseStyle = 
                (teeTime.course || teeTime.golf_course)?.includes('Î†àÏù¥ÌÅ¨') || (teeTime.course || teeTime.golf_course)?.includes('Lake') 
                  ? 'background-color: #DBEAFE; color: #1E40AF;' 
                  : (teeTime.course || teeTime.golf_course)?.includes('ÌûêÏä§') || (teeTime.course || teeTime.golf_course)?.includes('Hills')
                  ? 'background-color: #D1FAE5; color: #065F46;'
                  : (teeTime.course || teeTime.golf_course)?.includes('Î∞∏Î¶¨') || (teeTime.course || teeTime.golf_course)?.includes('Valley')
                  ? 'background-color: #EDE9FE; color: #5B21B6;'
                  : (teeTime.course || teeTime.golf_course)?.includes('Ïò§ÏÖò') || (teeTime.course || teeTime.golf_course)?.includes('Ocean')
                  ? 'background-color: #CFFAFE; color: #065F46;'
                  : (teeTime.course || teeTime.golf_course)?.includes('ÌÅ¥ÎüΩ') || (teeTime.course || teeTime.golf_course)?.includes('Club')
                  ? 'background-color: #FED7AA; color: #C2410C;'
                  : 'background-color: #F3F4F6; color: #374151;';
                  
                  return `
                    <tr>
                      ${index === 0 ? `
                        <td rowspan="${sortedPlayers.length}">${teeTime.tee_time}</td>
                        <td rowspan="${sortedPlayers.length}" style="${courseStyle} font-weight: bold;">${teeTime.course || teeTime.golf_course} ${teamGenderType}</td>
                        <td rowspan="${sortedPlayers.length}">${teeTime.team_no}ÌåÄ</td>
                      ` : ''}
                      <td class="players-cell">
                        <span class="player-name">${participant.name}</span>
                        ${genderMark ? `<span style="color: ${genderColor}; font-weight: bold; margin-left: 4px;">${genderMark}</span>` : ''}
                      </td>
                      ${isStaff ? `<td>${participant.phone || '-'}</td>` : ''}
                    </tr>
                  `;
                }).join('');
              } else {
                // Ìã∞ÌÉÄÏûÑÏóê ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ (Í∏∞Ï°¥ players ÌïÑÎìú ÏÇ¨Ïö©)
                const playerNames = teeTime.players ? JSON.parse(teeTime.players) : [];
                const courseStyle = 
                  (teeTime.course || teeTime.golf_course)?.includes('Î†àÏù¥ÌÅ¨') || (teeTime.course || teeTime.golf_course)?.includes('Lake') 
                    ? 'background-color: #DBEAFE; color: #1E40AF;' 
                    : (teeTime.course || teeTime.golf_course)?.includes('ÌûêÏä§') || (teeTime.course || teeTime.golf_course)?.includes('Hills')
                    ? 'background-color: #D1FAE5; color: #065F46;'
                    : (teeTime.course || teeTime.golf_course)?.includes('Î∞∏Î¶¨') || (teeTime.course || teeTime.golf_course)?.includes('Valley')
                    ? 'background-color: #EDE9FE; color: #5B21B6;'
                    : (teeTime.course || teeTime.golf_course)?.includes('Ïò§ÏÖò') || (teeTime.course || teeTime.golf_course)?.includes('Ocean')
                    ? 'background-color: #CFFAFE; color: #065F46;'
                    : (teeTime.course || teeTime.golf_course)?.includes('ÌÅ¥ÎüΩ') || (teeTime.course || teeTime.golf_course)?.includes('Club')
                    ? 'background-color: #FED7AA; color: #C2410C;'
                    : 'background-color: #F3F4F6; color: #374151;';
                    
                return `
                  <tr>
                    <td>${teeTime.tee_time}</td>
                    <td style="${courseStyle} font-weight: bold;">${teeTime.course || teeTime.golf_course}</td>
                    <td>${teeTime.team_no}ÌåÄ</td>
                    <td class="players-cell">
                      ${playerNames.length > 0 ? playerNames.join(', ') : '-'}
                    </td>
                    ${isStaff ? '<td>-</td>' : ''}
                  </tr>
                `;
              }
            