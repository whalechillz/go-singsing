# Google Sheets 고객 데이터 마이그레이션 최종 계획

## 개요
Google Sheets의 "singsing" 탭에서 고객 데이터를 가져와서 Supabase `customers` 테이블에 마이그레이션합니다.

## Google Sheets 정보
- URL: https://docs.google.com/spreadsheets/d/1MUvJyKGXFBZLUCuSnuOjZMjQqkSi5byu9d7u4O6uf9w/edit?gid=812281138#gid=812281138
- 시트명: singsing
- GID: 812281138

## 컬럼 구조 및 매핑

### Google Sheets 컬럼 → Supabase 필드 매핑

| Google Sheets 컬럼 | Supabase 필드 | 설명 |
|-------------------|--------------|------|
| 이름 (A) | `name` | 고객 이름 |
| 연락처 (B) | `phone` | 전화번호 (하이픈 제거 후 저장) |
| 최초문의일 (C) | `first_tour_date` | 최초 문의일 |
| 최근투어일 (D) | `last_tour_date` | 최근 투어일 |
| 최근투어지 (E) | `notes` (일부) | 최근 투어지역 (notes에 "최근 투어지: ..." 형식으로 추가) |
| 최근연락일 (F) | `last_contact_at` | 최근 연락일 |
| 모임명 (G) | `tags` | 모임명 (배열로 저장) |
| 특이사항 (H) | `notes` | 특이사항 (메모 필드에 저장) |
| 직급 (I) | `position` | 직급 (총무, 회장, 방장) |

## 데이터 처리 로직

### 1. 신규 고객 추가
- 전화번호가 고유하지 않은 경우 건너뜀
- 특이사항(컬럼 H) → `notes` 필드에 저장
- 직급(컬럼 I) → `position` 필드에 저장 (총무, 회장, 방장만 유효)
- 모임명(컬럼 G) → `tags` 배열에 추가
- 최근 투어지(컬럼 E) → `notes`에 "최근 투어지: ..." 형식으로 추가
- Google Sheets 행 번호 → `notes`에 "Google Sheets 행: XX" 형식으로 추가

### 2. 기존 고객 업데이트
기존 고객의 경우 다음 필드만 선택적으로 업데이트:

1. **모임명 (tags)**
   - 기존 tags와 병합 (중복 제거)
   - 새로운 모임명이 있으면 추가

2. **특이사항 (notes)**
   - 기존 notes에 새로운 특이사항 추가
   - "최근 투어지:" 및 "Google Sheets 행:" 제외한 순수 특이사항만 추가
   - 중복 체크 후 추가

3. **직급 (position)**
   - 기존 position이 `null`일 때만 업데이트
   - 컬럼 I에서 직접 읽은 값 사용

4. **최근 연락일 (last_contact_at)**
   - 더 최신 날짜로만 업데이트
   - 기존 날짜보다 새로운 날짜가 더 최신일 때만 업데이트

**보존되는 필드:**
- `total_tour_count` (투어 횟수)
- `first_tour_date` (최초 투어일)
- `last_tour_date` (최근 투어일)
- 기존 `position` (이미 값이 있는 경우)

## 마이그레이션 실행 방법

```bash
npm run migrate:customers:google-sheets
```

## 검증 방법

### 1. VIP2295 고객 확인
```bash
npm run check:vip2295
```

**확인 사항:**
- 특이사항이 `notes` 필드에 포함되어 있는지
- 최근 연락일이 2025-10-22로 저장되어 있는지

### 2. VIP2769 고객 확인
```bash
npm run check:vip2769
```

**확인 사항:**
- 직급이 "총무"로 저장되어 있는지
- 최근 연락일이 2025-06-17로 저장되어 있는지

### 3. 전체 마이그레이션 결과 확인
```bash
npm run check:customer-migration
```

**확인 사항:**
- 전체 고객 수
- 최근 연락일이 있는 고객 수
- 모임명(tags)이 있는 고객 수
- 직급이 있는 고객 수

## 주의사항

1. **여러 줄 셀 처리**
   - Google Sheets의 CSV 내보내기에서 여러 줄 셀은 따옴표로 감싸짐
   - 현재 파서는 기본 CSV 파싱을 사용하므로 대부분의 경우 정상 작동

2. **직급 필드**
   - 컬럼 I에서 직접 읽음
   - "총무", "회장", "방장"만 유효한 값으로 인정
   - 다른 값은 무시됨

3. **특이사항 필드**
   - 컬럼 H의 모든 내용이 `notes`에 저장됨
   - 여러 줄로 된 경우 줄바꿈이 유지됨

4. **기존 데이터 보존**
   - 기존 고객의 투어 이력은 절대 업데이트되지 않음
   - 기존 직급이 있으면 새로운 값으로 덮어쓰지 않음

## 예상 결과

- **신규 고객**: 약 3,900명 이상 추가
- **기존 고객**: 약 100명 이상 업데이트 (모임명, 특이사항, 직급 추가)
- **특이사항 포함**: 모든 고객의 특이사항이 메모에 저장됨
- **직급 포함**: 직급 컬럼에 값이 있는 고객의 직급이 저장됨

