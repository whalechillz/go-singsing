# 정산 시스템 개발 로드맵

## ✅ Phase 1: 데이터베이스 설계 및 마이그레이션 (완료)

- [x] `tour_expenses` 테이블 구조 개선
  - [x] 골프장 원가 컬럼 추가
  - [x] 버스 비용 상세 컬럼 추가
  - [x] 가이드 비용 컬럼 추가
  - [x] 경비 지출 구조화 (JSONB)
  - [x] 기타 비용 컬럼 추가
  - [x] 총 원가 자동 계산 트리거
- [x] `tour_settlements` 테이블 생성
  - [x] 매출 컬럼 (계약 매출, 완납 금액, 환불 금액, 정산 금액)
  - [x] 원가 컬럼 (총 원가)
  - [x] 마진 컬럼 (마진, 마진률)
  - [x] 상태 컬럼 (status, settled_at, settled_by)
  - [x] 마진 자동 계산 트리거
- [x] 인덱스 및 제약조건 설정
- [x] 컬럼 설명 추가

---

## 🚀 Phase 2: 투어별 정산 관리 UI (다음 단계)

### 2.1 정산 관리 페이지 생성
**경로**: `/app/admin/tours/[tourId]/settlement/page.tsx`

**기능**:
- 투어 상세 정보 표시
- 원가 입력/수정 폼
- 정산 요약 표시
- 정산서 생성 및 다운로드

**구현 순서**:
1. 페이지 기본 구조 생성
2. 투어 정보 가져오기
3. `tour_expenses` 데이터 가져오기/생성
4. `tour_settlements` 데이터 가져오기/생성

### 2.2 원가 입력 폼 구현

#### 2.2.1 골프장 정산 입력
- 골프장별 정산 상세 입력 (JSONB)
- 그린피, 카트비, 캐디피, 식사비 등
- 입금/차액 관리

#### 2.2.2 버스 비용 입력
- 버스 비용
- 기사 비용
- 톨게이트 비용
- 주차비
- 버스 비용 메모

#### 2.2.3 가이드 비용 입력
- 가이드 인건비
- 가이드 식사비
- 가이드 숙박비
- 가이드 기타 비용
- 가이드 비용 메모

#### 2.2.4 경비 지출 입력
- JSONB 배열로 관리
- 김밥/도시락, 생수/음료, 간식 등
- 단가, 수량, 총액 자동 계산

#### 2.2.5 기타 비용 입력
- 숙박비
- 식당 비용
- 관광지 입장료
- 보험료
- 기타 운영비

### 2.3 정산 요약 표시
- 계약 매출 (상품가 × 인원)
- 완납 금액 (입금 합계)
- 환불 금액
- 정산 금액 (완납 - 환불)
- 총 원가 (자동 계산)
- 마진 (정산 금액 - 총 원가)
- 마진률 (마진 / 정산 금액 × 100)

### 2.4 정산서 생성 기능
- 정산서 템플릿 디자인
- PDF 생성 (react-pdf 또는 jsPDF)
- 정산서 다운로드

---

## 📊 Phase 3: 정산 계산 로직

### 3.1 투어별 정산 계산 함수
- `tour_expenses` 데이터 기반 총 원가 계산
- `singsing_payments` 데이터 기반 완납 금액 계산
- `singsing_tours` 데이터 기반 계약 매출 계산
- 정산 금액, 마진, 마진률 계산

### 3.2 월별 정산 집계 함수
- 월별 투어별 정산 데이터 집계
- 월별 총 매출, 총 원가, 총 마진 계산
- 월별 마진률 계산

### 3.3 마진 및 마진률 계산
- 실시간 마진 계산
- 마진률 자동 계산
- 마진 분석 및 시각화

---

## 📈 Phase 4: 월별 정산 리포트 개선

### 4.1 대시보드 월별 매출 리포트 개선
- 정산 금액 기준으로 변경
- 실제 원가 기준으로 변경
- 원가 상세 항목 표시 (골프장, 버스, 가이드, 경비, 기타)
- 마진 및 마진률 표시

### 4.2 결제 관리 페이지 월별 매출 리포트 개선
- 정산 금액 기준으로 변경
- 실제 원가 기준으로 변경
- 원가 상세 항목 표시
- 마진 및 마진률 표시

---

## 📄 Phase 5: 정산서 생성

### 5.1 정산서 템플릿 디자인
- 정산서 레이아웃 디자인
- 매출, 원가, 마진 표시
- 원가 상세 항목 표시

### 5.2 PDF 생성 기능
- react-pdf 또는 jsPDF 사용
- 정산서 데이터를 PDF로 변환

### 5.3 정산서 다운로드 기능
- PDF 파일 다운로드
- 정산서 이메일 발송 (선택사항)

---

## 📊 Phase 6: 통계 및 리포트

### 6.1 투어별 정산 통계
- 투어별 매출, 원가, 마진 통계
- 투어별 마진률 분석

### 6.2 월별 정산 통계
- 월별 매출, 원가, 마진 통계
- 월별 마진률 추이

### 6.3 연간 정산 통계
- 연간 매출, 원가, 마진 통계
- 연간 마진률 분석

### 6.4 원가 분석 리포트
- 원가 항목별 분석
- 원가 최적화 제안

---

## 🎯 현재 개발 우선순위

### 즉시 시작 (Phase 2)
1. **정산 관리 페이지 기본 구조 생성**
   - `/app/admin/tours/[tourId]/settlement/page.tsx` 생성
   - 투어 정보 표시
   - 기본 레이아웃 구성

2. **원가 입력 폼 구현**
   - 골프장 정산 입력 폼
   - 버스 비용 입력 폼
   - 가이드 비용 입력 폼
   - 경비 지출 입력 폼
   - 기타 비용 입력 폼

3. **정산 요약 표시**
   - 실시간 계산 및 표시
   - 마진 및 마진률 표시

### 다음 단계 (Phase 3)
- 정산 계산 로직 구현
- 월별 정산 집계 함수 구현

### 이후 단계 (Phase 4-6)
- 월별 정산 리포트 개선
- 정산서 생성 기능
- 통계 및 리포트

---

## 📝 개발 체크리스트

### Phase 2 체크리스트
- [ ] 정산 관리 페이지 생성
- [ ] 투어 정보 표시
- [ ] `tour_expenses` 데이터 가져오기/생성
- [ ] `tour_settlements` 데이터 가져오기/생성
- [ ] 골프장 정산 입력 폼
- [ ] 버스 비용 입력 폼
- [ ] 가이드 비용 입력 폼
- [ ] 경비 지출 입력 폼
- [ ] 기타 비용 입력 폼
- [ ] 정산 요약 표시
- [ ] 실시간 계산 및 업데이트
- [ ] 정산서 생성 기능 (선택사항)

---

## 🔧 기술 스택

- **프론트엔드**: React + Next.js + TypeScript
- **스타일링**: Tailwind CSS
- **데이터베이스**: Supabase (PostgreSQL)
- **PDF 생성**: react-pdf 또는 jsPDF
- **차트**: recharts (기존 사용 중)

---

## ⏱️ 예상 작업 시간

- **Phase 2**: 6-8시간
- **Phase 3**: 3-4시간
- **Phase 4**: 4-5시간
- **Phase 5**: 3-4시간
- **Phase 6**: 3-4시간
- **총 예상 시간**: 19-25시간

---

## 📚 참고 문서

- `docs/SETTLEMENT_SYSTEM_PLAN.md`: 정산 시스템 전체 계획
- `docs/SETTLEMENT_MIGRATION_GUIDE.md`: 마이그레이션 가이드
- `supabase/migrations/20251108_update_tour_expenses.sql`: tour_expenses 테이블 마이그레이션
- `supabase/migrations/20251108_create_tour_settlements.sql`: tour_settlements 테이블 마이그레이션

